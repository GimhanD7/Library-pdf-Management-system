<?php

namespace App\Http\Controllers;

use App\Models\Publication;
use App\Models\User;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class DashboardController extends Controller
{
    /**
     * Get dashboard statistics
     */
    public function getStatistics(): JsonResponse
    {
        try {
            // Check database connection
            if (!DB::connection()->getPdo()) {
                throw new \Exception('Database connection failed');
            }
            
            $user = auth()->user();
            if (!$user) {
                return response()->json(['error' => 'Not authenticated'], 401);
            }
            
            // Get statistics
            $stats = [
                'total_publications' => $this->getTotalPublications(),
                'active_users' => $this->getActiveUsersCount(),
                'new_this_month' => $this->getNewThisMonthCount(),
                'pending_reviews' => $this->getPendingReviewsCount(),
                'recent_activity' => $this->getRecentActivity()
            ];

            return response()->json($stats);
            
        } catch (\Exception $e) {
            Log::error('Error in getStatistics: ' . $e->getMessage());
            
            return response()->json([
                'error' => 'Failed to load dashboard data',
                'message' => $e->getMessage()
            ], 500);
        }
    }

    protected function getTotalPublications(): int
    {
        return Publication::count();
    }

    protected function getActiveUsersCount(): int
    {
        return User::where('last_login_at', '>=', now()->subDays(7))->count();
    }

    protected function getNewThisMonthCount(): int
    {
        return Publication::whereYear('created_at', now()->year)
            ->whereMonth('created_at', now()->month)
            ->count();
    }

    protected function getPendingReviewsCount(): int
    {
        return Publication::where('status', 'pending_review')->count();
    }

    protected function getRecentActivity(): array
    {
        // Get recent publications
        $publications = Publication::with('user')
            ->latest()
            ->take(5)
            ->get()
            ->map(function ($publication) {
                return [
                    'id' => $publication->id,
                    'title' => 'New Publication',
                    'description' => $publication->title,
                    'time' => $publication->created_at->diffForHumans(),
                    'type' => 'publication',
                    'icon' => 'book-open'
                ];
            });

        // Get recent user registrations
        $users = User::latest()
            ->take(5)
            ->get()
            ->map(function ($user) {
                return [
                    'id' => $user->id,
                    'title' => 'New User Registration',
                    'description' => $user->name . ' joined the platform',
                    'time' => $user->created_at->diffForHumans(),
                    'type' => 'user',
                    'icon' => 'user'
                ];
            });

        // Combine and sort by creation date
        return $users->merge($publications)
            ->sortByDesc('time')
            ->take(5)
            ->values()
            ->toArray();
    }
}
